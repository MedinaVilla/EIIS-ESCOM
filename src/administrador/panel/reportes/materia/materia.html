<html>

<head>
    <title>
        Materias
    </title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="assets/img/logoESCOM.png" />
    <link rel="stylesheet" type="text/css" href="assets/css/materialize/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
    <script src="assets/js/chart.js"></script>
    <script src="assets/js/jquery-3.4.1.min.js"></script>
    <script src="assets/js/materialize.min.js"></script>
</head>

<body>
    <div>
        <nav>
            <div class="nav-wrapper">
                <a href="./panel" class="brand-logo"> &nbsp;<b>EIIS-ESCOM</b></a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li><a href="./panel">Inicio</a></li>
                    <li><a href="./alumnos">Buscar Alumno</a></li>
                    <li><a class="dropdown-trigger" data-target="dropdown1">Reportes<i
                                class="material-icons right">arrow_drop_down</i></a></li>
                    <li><b><a href="./cerrarsesion">Cerrar sesión</a></b></li>
                </ul>
            </div>
        </nav>
        <br />
        <h3 class="container">Reportes por materia</h3><br />
        <form class="container col s12">
            <div class="row">
                <div class="input-field col s12">
                    <select onChange="getMateriaData();" id="materias">
                        <option value="" disabled selected>Seleccione una materia</option>
                    </select>
                </div>
            </div>
        </form>
        <div  id="report_page" class="container">
            <h3 id="materiaTitle" align="center"></h3>
            <br />
            <div class="row">
                <div class="col s6">
                    <br />
                    <h3 id="numberTotal" align="CENTER">
                        </h4>
                        <br />
                        <h4 id="numberPrimeraVez" align="CENTER"></h4>
                        <h4 id="numberRecursamiento" align="CENTER"></h4>
                </div>
                <div class="col s6">
                    <canvas id="pie-chart2" width="100%" height="100%"></canvas>
                </div>
            </div>
            <div id="buttonPDF" align="CENTER" style="display:none">
                <button onClick="getPDF();" class="waves-effect waves-light btn-large"><i
                        class="material-icons right">picture_as_pdf</i>Obtener PDF</a>
            </div>
        </div>
        <br />
        <div id="pdfcontent">

        </div>
    </div>
    <!-- Dropdown Structure -->
    <ul id="dropdown1" class="dropdown-content">
        <li><a href="./reporte_alumno">Alumno</a></li>
        <li class="divider"></li>
        <li><a href="./reporte_materia">Materia</a></li>
    </ul>
    <script>
        $(document).ready(function () {
            $.ajax(
                './src/administrador/panel/reportes/materia/getMaterias.php',
                {
                    success: function (response) {
                        let materias = JSON.parse(response);
                        $.each(materias, function (index, item) {
                            let Options = "";
                            Options = Options + "<option value='" + item.materia + "'>" + item.materia + "</option>";
                            $('#materias').append(Options);
                            $('#materias').formSelect()
                        });
                    },
                    error: function () {
                        alert('There was some error performing the AJAX call!');
                    }
                }
            );
            $('.dropdown-trigger').dropdown();
        });
        //END Dropdown Structure 

        function getMateriaData() {
            let materia = document.getElementById("materias").value
            document.getElementById("materiaTitle").innerHTML = materia;
            // Peticion AJAX para obtener los datos
            $.ajax(
                './src/administrador/panel/reportes/materia/graphData.php',
                {
                    type: "POST",
                    data: {
                        materia: materia
                    },
                    success: function (response) {
                        let materia = JSON.parse(response);

                        let primeravez = parseInt(materia[0].inscritos_regular);
                        let recursamiento = parseInt(materia[0].inscritos_recurse);
                        let total = primeravez + recursamiento;

                        document.getElementById("numberTotal").innerHTML = "Total: <b>" + total + "</b>";
                        document.getElementById("numberPrimeraVez").innerHTML = "Primera vez: <b>" + primeravez + "</b>";
                        document.getElementById("numberRecursamiento").innerHTML = "Recursamiento: <b>" + recursamiento + "</b>";
                        document.getElementById("buttonPDF").style.display = "block";

                        //Fill the chart data
                        new Chart(document.getElementById("pie-chart2"), {
                            type: 'pie',
                            data: {
                                labels: ["Primera vez", "Recursamiento"],
                                datasets: [{
                                    label: "Numero de alumnos",
                                    backgroundColor: ["#c45850", "#3cba9f"],
                                    data: [primeravez, recursamiento]
                                }]
                            },
                            options: {
                                title: {
                                    display: true,
                                    text: 'Alumnos escritos por primera vez y recursamiento'
                                }
                            }
                        });


                    },
                    error: function () {
                        alert('There was some error performing the AJAX call!');
                    }
                }
            );
        }

        function getPDF() {
   
            // get size of report page
            var reportPageHeight = $('#report_page').innerHeight();
            var reportPageWidth = $('#report_page').innerWidth();

            // create a new canvas object that we will populate with all other canvas objects
            var pdfCanvas = $('<canvas />').attr({
                id: "canvaspdf",
                width: reportPageWidth,
                height: reportPageHeight
            });
            // keep track canvas position
            var pdfctx = $(pdfCanvas)[0].getContext('2d');
            var pdfctxX = 0;
            var pdfctxY = 0;
            var buffer = 100;

            // for each chart.js chart
            $("canvas").each(function (index) {
                // get the chart height/width
                var canvasHeight = $(this).innerHeight();
                var canvasWidth = $(this).innerWidth();

                // draw the chart into the new canvas
                pdfctx.drawImage($(this)[0], pdfctxX, pdfctxY, canvasWidth, canvasHeight);
                pdfctxX += canvasWidth + buffer;

                // our report page is in a grid pattern so replicate that in the new canvas
                if (index % 2 === 1) {
                    pdfctxX = 0;
                    pdfctxY += canvasHeight + buffer;
                }
            });

            // create new pdf and add our new canvas as an image
            var pdf = new jsPDF('l', 'pt', [reportPageWidth, reportPageHeight]);
            pdf.setFontType('bold');
            pdf.text(230, 50, 'ESCUELA SUPERIOR DE CÓMPUTO');
            pdf.text(175, 100, 'REPORTE DE ALUMNOS INSCRITOS DE LA MATERIA');
            pdf.text(175,150,'"'+ document.getElementById("materias").value+'"');
            pdf.setFontType('Comic Sans');
            pdf.text(175,250, document.getElementById("numberTotal").textContent);
            pdf.text(175,310, document.getElementById("numberPrimeraVez").textContent);
            pdf.text(175,350, document.getElementById("numberRecursamiento").textContent);
            pdf.addImage($(pdfCanvas)[0], 'PNG', 350, 200);

            // download the pdf
            pdf.save('reporte_'+document.getElementById("materias").value+'.pdf');

            // $.ajax(
            //     './generatePDF',
            //     {
            //         type: "POST",
            //         data: { materia: document.getElementById("materias").value },
            //         success: function (response) {
            //             console.log(response);
            //             location.href = "./reportes/reporte_calculo.pdf"
            //         },
            //         error: function () {
            //             alert('There was some error performing the AJAX call!');
            //         }
            //     }
            // );
        }

        $(document).ready(function () {
            $('select').formSelect();
        });
    </script>
</body>

</html>